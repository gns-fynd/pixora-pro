## Pixora AI Video Creation Platform

### 1. Introduction
**Pixora** is a cloud‑native AI‑powered SaaS platform that transforms simple text prompts into fully edited, professional‑quality videos. Built for speed and scalability, Pixora guides a user from prompt analysis all the way through final export—allowing on‑the‑fly edits via an intuitive browser‑based editor.

### 2. Core Functionality
1. **Prompt Analysis & Script Generation**  
   - Uses OpenAI GPT as an orchestrator agent to deeply interpret the user’s prompt.  
   - Breaks the prompt into a sequence of scenes, generating a narrative script and visual descriptions.

2. **Scene Asset Generation**  
   - **Text→Image**: Fal.ai model creates a reference image per scene.  
   - **Image→Video**: Fal.ai model animates each image into a short video clip.  
   - **Text→Speech**: Fal.ai model produces voiceover narration for each scene’s script.  
   - **Text→Music**: Fal.ai model composes background music, with continuity rules (e.g., reuse tracks for similar scenes, switch tone as narrative shifts).

3. **Transition & Continuity Planning**  
   - An AI agent decides appropriate transition animations (e.g. `fade`, `slide`) between scenes.  
   - Music continuity hints guide whether to reuse or regenerate tracks across scene groups.

4. **Client‑Side Composition & Export**  
   - Uses ffmpeg.wasm in the browser to mix clips, audio tracks, and transitions into a final MP4.  
   - Editor state (volume levels, overlays, transitions) is stored as a JSONB blob for full fidelity round‑trip edits.

5. **Iterative Editing**  
   - Users can adjust any component—volume, text overlays, transitions—directly in the browser.  
   - Each save produces a new version (up to 5) with its own editor state and rendered URL.

6. **User Management & Billing**  
   - **Supabase Auth** for secure user sign‑up/sign‑in with JWT and row‑level security.  
   - Credit‑based system: user profiles track balances; credits are deducted upfront per video duration.  
   - Transactions logged in `credit_transactions`, balances in `profiles`.

### 3. High‑Level Architecture

```mermaid
flowchart TD
  subgraph Frontend
    A[Next.js App] -->|Sign-in| B(Supabase Auth)
    A -->|API Calls| C(FastAPI)
    A -->|Fetch Assets| S[Supabase Storage]
    A -->|ffmpeg.wasm| E[Browser Export]
  end

  subgraph Backend
    C -->|Verify JWT| B
    C -->|Queue Task| Q[Redis/Celery]
    Q --> R[PromptAnalyzer Worker]
    R --> D[Scenes & Revisions (Postgres)]
    Q --> G[AssetGenerator Worker]
    G --> S
    C -->|Read/Write| D[(Supabase Postgres)]
  end

  subgraph AI Agent
    UserPrompt --> Agent[OpenAI Agents SDK]
    Agent --> ScriptWriter
    Agent --> ScenePlanner
    Agent --> ImageGen
    Agent --> VideoGen
    Agent --> SpeechGen
    Agent --> MusicGen
    Agent --> TransitionPlanner
    Agent --> ApplyEditor
  end
```

### 4. Technical Components

| Layer                   | Technology                                   |
|-------------------------|----------------------------------------------|
| **Frontend**            | Next.js, React, ffmpeg.wasm, SWR/Zustand      |
| **Authentication**      | Supabase Auth (JWT, RLS)                     |
| **Database & Storage**  | Supabase Postgres (JSONB columns, RLS), Storage|
| **API & Orchestration** | FastAPI, supabase‑py client, Uvicorn/Gunicorn|
| **Background Workers**  | Celery with Redis (Upstash)                  |
| **AI Orchestration**    | OpenAI Agents SDK (gpt-4o-mini)              |
| **AI Models**           | Fal.ai (text→image, image→video, text→speech, text→music) |
| **CI/CD & Hosting**     | Vercel (frontend), Render (backend, workers) |
| **Monitoring & Logs**   | Render logs, optional Sentry                  |

### 5. Data Model Summary

- **videos**: stores prompt, status, final_url, credits_used, metadata (duration, aspect ratio, style)  
- **scenes**: one record per scene, references `scene_revisions`  
- **scene_revisions**: up to 5 GPT breakdowns, stores full JSON response  
- **scene_assets**: links images/clips/audio to a revision via `revision_id`  
- **video_versions**: up to 5 user edits, stores `editor_state` JSONB and rendered URLs  
- **profiles**: user_id ↔ current credit balance  
- **credit_transactions**: ledger of credit deltas per action

### 6. API Endpoints

| Method | Path                                               | Purpose                                           |
|--------|----------------------------------------------------|---------------------------------------------------|
| POST   | `/api/v1/videos`                                   | Start a new video job (deduct credits)            |
| GET    | `/api/v1/videos`                                   | List all videos generated by the current user     |
| GET    | `/api/v1/videos/{id}`                              | Retrieve job status & metadata for a single video |
| GET    | `/api/v1/videos/{id}/scenes`                       | List scenes and asset URLs for a video            |
| POST   | `/api/v1/videos/{id}/scenes/{sid}`                 | Regenerate a specific scene revision              |
| POST   | `/api/v1/videos/{id}/versions`                     | Save editor state & create new version            |
| GET    | `/api/v1/videos/{id}/versions/{vid}`               | Fetch editor state & video URL for re‑edit preview|
| GET    | `/api/v1/users/me/credits`                         | Check current credit balance                      |
| GET    | `/api/v1/users/me/profile`                         | View the current user's profile                   |
| PATCH  | `/api/v1/users/me/profile`                         | Update the current user's profile                 |
| POST   | `/api/v1/auth/request-password-reset`              | Send password reset email via Supabase Auth       |
| POST   | `/api/v1/auth/reset-password`                      | Confirm password reset with token and new password|

### 7. AI Agent Workflow AI Agent Workflow AI Agent Workflow AI Agent Workflow
1. **ScriptWriter**: GPT generates narrative and scene scripts.  
2. **ScenePlanner**: Splits script into scenes with descriptions.  
3. **ImageGen** & **VideoGen**: Build visual clips.  
4. **SpeechGen**: Produce narrated audio.  
5. **MusicGen**: Compose or reuse BGM with thematic continuity.  
6. **TransitionPlanner**: Select transitions between scenes.  
7. **ApplyEditor**: ffmpeg.wasm compiles all assets + editor state into MP4.

### 8. Deployment & Next Steps
- **Frontend**: Vercel (Next.js)  
- **Backend & Workers**: Render (Docker services + Upstash Redis)  
- **Cron Jobs**: Render scheduler for pruning old revisions/versions.  
- **Secrets**: Store Supabase keys, OpenAI & Fal.ai API keys securely in Render.  
- **Manual Testing**: Exercise end‑to‑end flows, validate RLS, credit deductions, agentic edits.

Once validated, you can add payment gateways (Stripe), CI/CD pipelines, and deeper monitoring to move from MVP into production readiness.

